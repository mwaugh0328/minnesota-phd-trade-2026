\documentclass[12pt,pdftex]{article}
\usepackage[pdftex]{graphicx,color}
\usepackage{setspace,palatino,multirow}
\usepackage{amsmath,amssymb}
\usepackage{titlesec}
\usepackage{lscape}
%\usepackage{subfigure}
\usepackage{threeparttable}
\usepackage{natbib}
\bibliographystyle{ecta}
\usepackage{cite}
\usepackage{booktabs}
\usepackage{subcaption}
\usepackage{pdflscape}
\usepackage{afterpage}
\usepackage{xcolor}
\usepackage{rotating}
\usepackage[listings, most]{tcolorbox}
\definecolor{nblue}{RGB}{0,0,128}
\usepackage{afterpage}


\usepackage[pdftex,colorlinks=true, bookmarks=false,
pdfstartview={XYZ null null 0.85},
pdftitle={Teaching Notes: Eaton and Kortum (2002)},
pdfauthor={Michael E. Waugh},
pdfkeywords={},
colorlinks=true,linkcolor=darkgray,citecolor=darkgray,urlcolor=darkgray,
breaklinks]{hyperref}


\newcounter{saveeqni}%
\newcounter{saveeqn01i}%
\newcommand{\alpheqni}{\setcounter{saveeqni}{\value{section}}%
%\setcounter{saveeqn01i}{\value{subsectioni}}%
\renewcommand{\theequation}
    {\alph{saveeqni}\mbox{.\arabic{equation}}}}%
\newcommand{\reseteqni}{\setcounter{equation}{\value{saveeqni}}%
\renewcommand{\theequation}{\arabic{equation}}}%

\newtheorem{as}{Assumption}
\newtheorem{reg}{Regularity Condition}
\newtheorem{conjecture}{Conjecture}
\newtheorem{corr}{Corollary}
\newtheorem{df}{Definition}
\newtheorem{lemma}{Lemma}
\newtheorem{prp}{Proposition}
\newtheorem{rmk}{Remark}
\newenvironment{prf}{{\bf Proof}}{\hfill { }}

\DeclareMathOperator*{\plim}{plim}
\DeclareMathOperator*{\umax}{max}

\special{papersize=8.5in,11in}
\onehalfspacing
\setlength{\parindent}{0.1em}
\setlength{\parskip}{.09in}
\textwidth15.75cm
\evensidemargin 1.5in
\oddsidemargin 1.5in
\topmargin 8.5cm
\textheight 10in
\hyphenation{over-lapping}

\tcolorboxenvironment{prp}{%
boxrule = 0mm, breakable, colframe=white,
before skip=5pt,after skip=5pt,
colback=gray!5!white,
top = 2mm,
bottom = 2mm%,
%borderline north={1pt}{1pt}{gray},
%borderline south={1pt}{1pt}{gray}
}

\titleformat{\section}{\color{black}\large\bf}{\color{black}{\thesection.}}{.25cm}{}
\titleformat{\subsection}{\color{black}\normalsize\bf}{\thesubsection.}{.5em}{}
\titleformat{\subsubsection}{\color{black}\normalsize\bf}{\thesubsubsection.}{.5em}{}

\titlespacing{\section}{0pt}{*1.5}{*.5}
\titlespacing{\subsection}{0pt}{*1.5}{*.5}
\titlespacing{\subsubsection}{0pt}{*1.5}{*.5}

\def\thesection{\arabic{section}}
\def\thesubsection{\arabic{section}.\arabic{subsection}}
\def\thesubsubsection{\arabic{section}.\arabic{subsection}.\Alph{subsubsection}}

\def\citeapos#1{\citeauthor{#1}'s (\citeyear{#1})}

\renewcommand{\arraystretch}{1.1}
\usepackage[margin=2cm]{geometry}



\begin{document}

\begin{onehalfspacing}

\centerline{\large\textbf{Customer Heterogeneity, by Mike Waugh}}

In this set of notes I'm going to discuss incorporating heterogeneous agents households into what we have been working on. Some of this is quite new. First, it builds on my HAT paper or \citet{waugh2023heterogeneous}. But the even newer bit is that work with Simon and I in \citet{p-iq} has pushed the frontier forward in a way that basically allows one to think about \citet{eaton2002technology} and HAT in a seamless way. This is what the focus will be on.

\section{Why did I start working on HAT?}

There are essentially two issues that I had in my head and captivated me.

\textbf{1.} The first issue is an empirical fact about heterogeneous price sensitivity. \citet{auer2022unequal} document that poorer households have higher elasticities of substitution. They arrive at this conclusion by studying microdata on Swiss household purchases of Swiss versus French varieties within the same goods category following exogenous relative price changes due to the 2015 Swiss Franc appreciation. Subject to the same, exogenous, decline in prices of French varieties, poor households substituted spending toward French varieties at a significantly higher elasticity.

This fact is interesting to me for three reasons. One is that it sounds intuitively right, that is poor households care more about prices than rich households. Second, this kind of mechanism is completely abstracted from in basic macro and/or trade models. For example, CES preferences has the implication that even with heterogeneous households, all households substitute in the same way.

Related to the previous point, is that for a lot of questions, what really matters is how things change, not levels. Let's first think about a lesson of BEJK. In that model, it was designed to speak to an issue about levels, e.g. TFPR dispersion across firms. But for counter-factual questions, how markups and TFPR change is critical. And they wrote down a model where the distribution of markups and TFPR \textbf{do not} change in response to a shock.

The same idea is present when thinking about household heterogeneity and trade. If we want to have a model where household heterogeneity matters for trade, then we need heterogeneity to influence how the economy responds to a change in a trade shock. If households are heterogeneously exposed to trade, but all substitute in the same exact way, then how the economy will respond to a trade shock will likely be the same as in an appropriately constructed rep-agent economy.

\textbf{2.} The second idea relates to the integration of trade issues and international asset market issues. Often these are kept separate. An argument for this separation would go something like this: there might be feedback between overall demand conditions, the level of trade flows, demand for assets, and international asset prices. But with CES preferences, the \textbf{relative demand} for goods from different countries is independent of what is going on the asset side of the economy. So the financial market side does not matter for relative trade flows.

HAT breaks this link and in fact there is feedback between the two. I still have not really dug into this that much, but it is something that is / has been at the top of my mind.

\section{The HAT (Shopping Cart) Environment}

Here is the deal. The recent big insight is that HAT, \citet{p-iq}, can be set up in a way that it is essentially the same as in \citet{eaton2002technology}. Let's talk through this to make it crystal clear.

\textbf{Commodity space:} Goods are indexed by \( \omega \in [0,1] \). There are $J$ countries. Competitive firms in each country can produce good $\omega$, so each country's ``version'' of $\omega$ is not differentiated | they are perfect substitutes.

\textbf{Consumers' Preferences.} In each country, there are heterogeneous consumers with preferences:
\begin{align}
\mathbb{E}_{0} \sum_{t = 0}^{\infty} \beta^t \, \int_0^1 \bigg\{ \sum_{j} x_{njt}(\omega) \bigg[ u( c_{njt}(\omega)) + \epsilon_{njt}^k(\omega) \bigg ] \bigg \}  d\omega.
\label{eq:utility}
\end{align}
where $k$ is the identity / name of a consumer in country $n$. First, there is the dynamic part of these preferences, which is standard with time separability across dates and constant discounting. Second, there is the within-period part. First notice that this within-period part is very similar to that discussed in \citet{eaton2002technology}. As before, $x_{nj}(\omega)$ is an indicator function that takes the value one if good $\omega$ is sourced from $j$ and zero for all other destinations. Again, I express preferences in this way to emphasize the discrete choice nature of the problem.

What is different relative to \citet{eaton2002technology} is the incorporation of an additive taste shock $\epsilon_{njt}^k(\omega)$. These taste shocks are idiosyncratic to consumer $k$ and across time. Note that the consumer receives $J$ of these shocks for each $\omega$, every time period $t$. Moreover, the taste shocks are assumed to follow a Type 1 Extreme Value distribution (which we will discuss below).

What are these shocks doing? In a nutshell, it makes the good choice not all about price any more. Even though some good may have a low price, a household might want to buy a slightly higher-priced good because their shock $\epsilon_{njt}^k(\omega)$ might be really good. The basic idea in HAT and \citet{p-iq} is that a household's wealth influences this trade-off between price and tastes for a good.

This is different from the public versions of HAT or \citet{p-iq}. In the older versions, there is a ``one good at a time'' assumption. Here we have this ``shopping cart'' version. Its much better for many reasons. But one of the things we like about it is to get into the life of what the consumer is thinking: I need some detergent so which variety to buy, I need some ketchup so which variety, etc. So the household is consuming all goods, but only one variety of that good. Again, introspect on how \citet{eaton2002technology} is set up | it's the same exact idea. In contrast, think about how ``fruit salad'' models work: I buy all varieties of detergent and all varieties of ketchup and etc.

\textbf{Consumers' Endowments.} Households can save and borrow in a non-state-contingent asset $a$, which is denominated in the units of the numeraire. One unit of the asset pays out with gross interest rate $R_{n}$ next period. Households face an exogenous debt limit $\phi$ that constrains borrowing so that
\begin{align}
a_{t+1} \geq - \phi_{n}.
\label{eq:borrowing-constraint}
\end{align}
These pieces come together in the household's budget constraint; focusing on a stationary setting where prices are constant:
\begin{align}
\int_0^1 \sum_{j\in J} x_{njt}(\omega) p_{njt}(\omega) \, c_{njt}(\omega) d\omega +  a_{t+1} \ \ \leq \ \   R_{nt} a_{t} +  w_{nt} z_{t} .\label{eq:budget-constraint}
\end{align}
The value of consumption expenditures and asset holdings must be less than or equal to asset payments and labor earnings.

A natural question here is why? Why not do something simpler? As you see below, \emph{\textbf{the}} issue in the model is the marginal utility of wealth. And the standard incomplete markets model is \emph{\textbf{the}} model to use when thinking about the distribution marginal utility of wealth.

\textbf{Technologies and Trade Frictions.} Competitive producers in country \( j \), to produce a good \( \omega \), have access to a labor-only technology defined by the productivity level $z_j$. This productivity level is not indexed by $\omega$. So I'm going to abstract from productivity heterogeneity across goods | this will make my life easier. Specifically, all producers of \textbf{any} good \( \omega \) in country \( j \) have access to the production function:
\begin{align}
y_j(\omega) &= z_j n_j, \label{eq:production}
\end{align}
where labor efficiency units, $n_j$, is the only factor of production. Another way to think about this assumption is that all markets $\omega$ are symmetric.

Frictions to trade are modeled as iceberg trade costs in the usual way.

\textbf{Endowments.} Finally, each country has a labor endowment of mass $L_i$.

\subsection{The Recursive Formulation}

Now what I want to walk through is some properties of the household problem. Let's focus on a household given some assets and productivity shock, in country $n$. I'm also not going to impose the assumption that I made above about symmetry across markets; I'll do it later. The household has the following problem:
\begin{align}
v_{n,t}(a_{t}, z_{t}) = &\max\limits_{\ x_{njt}(\omega), \ c_{njt}(\omega), \ a_{t+1} } \int_0^1 \bigg\{ \sum_{j\in J} x_{njt}(\omega)  \bigg[ u( c_{njt}(\omega) ) + \epsilon_{njt}(\omega) \bigg ] \bigg \}  d\omega \, + \,  \beta \, \mathbb{E} \, v_{n,t+1} (a_{t+1}, z_{t+1}) \nonumber \\
 \\
+& \, \lambda_{nt}(a_{t},z_{t}) \bigg[ w_{nt} \, z_{t} + R_{nt} \, a_{t} - a_{t+1} - \underbrace{\int_0^1 \sum_{j\in J} x_{njt}(\omega) p_{njt}(\omega) \, c_{njt}(\omega)}_{e_{nt}(a_t, z_t)} \bigg]. \nonumber
\end{align}
where I'll term $e_{nt}(a_t, z_t)$ as expenditure. And I'm ignoring the borrowing constraint in the presentation.

How to solve this problem? It looks very intractable. Here is a key observation: with the continuum of goods assumption, the variety choice is independent of dynamic considerations. That is, whether I consume orange juice from Brazil or orange juice from the US is an infinitesimal fraction of my total expenditure, and thus it has no impact on how much I should save today. This then essentially makes the goods choice static. Let's walk through this\ldots

As usual, the optimal consumption choice satisfies
\begin{align}
 u'(c_{njt}(\omega)) = \lambda_{n,t}(a,z) \, p_{njt}(\omega), \label{eq:ce-intensive}
\end{align}
where the marginal utility of the goods is set equal to the marginal cost, which is how much income it takes as given by $p_{njt}(\omega)$ and then converted into utils at the marginal utility of wealth given by the multiplier $\lambda_{n,t}(a,z)$. Then the optimal discrete choice is the comparison across the different choices, good by good. This argument is exactly the same as in my presentation of \citet{eaton2002technology}, so
\begin{align}
\bigg[ u(c_{n1t}(\omega)) + &\epsilon_{n1t}(\omega) - \lambda_{n,t}(a,z) p_{n1t}(\omega) c_{n1t}(\omega) \bigg] \quad \mbox{vs.} \quad \nonumber \\
&\bigg[ u(c_{n2t}(\omega)) + \epsilon_{n2t}(\omega)  - \lambda_{n,t}(a,z) p_{n2t}(\omega) c_{n2t}(\omega) \bigg] \quad \mbox{vs.} \ \ldots
\end{align}
where all the constant terms cancel out. The important term to cancel out is the $\mathbb{E} \, v_{n,t+1} (a_{t+1}, z_{t+1})$ term from the value function and the $a_{t+1}$ term in the budget constraint. This is where the discussion above matters: each $\omega$ good is infinitesimal, so the particular choice of a variety does not affect $\mathbb{E} \, v_{n,t+1} (a_{t+1}, z_{t+1})$ nor the choice $a_{t+1}$. Then the optimal choice rule is:
\begin{align}\label{eq:choice-rule}
x_{njt}(\omega)(a_{t},z_{t}) = \begin{cases}
1 , & \mbox{if} \ \  u(c_{njt}(\omega)) + \epsilon_{njt}(\omega) - \lambda_{n,t}(a,z) p_{njt}(\omega) c_{njt}(\omega) \\
\\
& \quad \quad \geq \, \max\limits_{j' \in J} \bigg \{ \ u(c_{nj't}(\omega)) + \epsilon_{nj't}(\omega)  - \lambda_{nt}(a,z) p_{nj't}(\omega) c_{nj't}(\omega) \ \bigg \} \\
\\
0, & \ \mbox{otherwise}
\end{cases}
\end{align}
Then the optimal asset choice satisfies
\begin{align}
\lambda_{n,t}(a_{t},z_{t}) = \beta \, \mathbb{E} \, v_{t,a'} (a_{t+1},z_{t+1})
\end{align}
and then with the envelope condition we have that
\begin{align}
\lambda_{n,t}(a_{t},z_{t}) = \beta \, R_{t+1} \, \mathbb{E} \, \lambda_{n,t+1}(a_{t+1},z_{t+1}) \label{eq:euler}
\end{align}
At this point we have the three key equations that characterize the solution to the household problem:
\begin{itemize}
\item The static consumption choice in (\ref{eq:ce-intensive}), which determines the intensive margin as to how much to consume.

\item The choice rule in (\ref{eq:choice-rule}), which determines which national variety to consume.

\item The Euler equation in (\ref{eq:euler}), which relates the marginal utility of wealth across time periods.
\end{itemize}
One thing to note quickly is how the marginal utility of wealth $\lambda$ is playing a critical role here. Obviously it dictates the asset choice and intensive margin choice. But the choice rule in (\ref{eq:choice-rule}) also depends upon the marginal utility of wealth. In essence, this setup gives a very powerful role to the marginal utility of wealth in shaping outcomes.

\section{Aggregation}

What we want to do now is to aggregate and get towards some statements about trade and trade elasticities. In the presentation below, I'm going to assume that we are in a stationary equilibrium where time subscripts can be suppressed.

The first step is to construct the choice probability. So what we are going to do is compute the following integral:
\begin{align}
\pi_{nj}(\omega)(a,z) = \int_{-\infty}^{\infty}  x_{nj}(\omega)(a,z) \, d \epsilon
\end{align}
Fix a good $\omega$, a particular source $j$, and a particular type of consumer with states $(a,z)$. Now integrate \textbf{across possible taste shocks} to find the probability $\pi_{nj}(\omega)(a,z)$ that variety $j$ is chosen for good $\omega$. Notice that the taste shocks generate variation in the $x^k_{njt}(\omega)(a,z)$ indicator functions. That is, identical consumers in terms of states are making different variety choices.

I want to make a couple of arguments to construct this integral. Note that in (\ref{eq:choice-rule}) we can convert the $c$s into functions of $\lambda_{n}$ and $p$s. So
\begin{align}
u(c_{nj}(\omega)) - \lambda_{n}(a,z) \, p_{nj}(\omega) \, c_{nj}(\omega) =& \frac{c_{nj}(\omega)^{1-\sigma}}{1-\sigma} - \lambda_{n}(a,z) \, p_{nj}(\omega) \, c_{nj}(\omega) \\
\nonumber \\
=& \frac{(\lambda_{n}(a,z) p_{nj})^{(\sigma-1)/\sigma}}{1-\sigma} - (\lambda_{n}(a,z) p_{nj}(\omega))^{(\sigma-1)/\sigma}
\end{align}
where the last line follows from substituting in $c_{nj}(\omega) = (\lambda_{n} p_{nj}(\omega))^{-1/\sigma}$. Then one more step to simplifying gives
\begin{align}
= (\lambda_{n}(a,z) p_{nj}(\omega))^{(\sigma-1)/\sigma} \cdot \frac{\sigma}{1-\sigma}
\end{align}
Then define $\eta$ as the shape parameter on the Type 1 Extreme Value distribution. This then gives rise to the following choice probabilities:
\begin{align}
\pi_{nj}(\omega)(a,z) =  \frac{\exp\bigg\{ \eta \cdot \big[\lambda_{n}(a,z) p_{nj}(\omega)\big]^{(\sigma-1)/\sigma} \cdot \frac{\sigma}{1-\sigma} \bigg \} }{\sum\limits_{j' \in J} \exp\bigg\{ \eta \cdot \big[\lambda_{n}(a,z) p_{nj'} (\omega) \big]^{(\sigma-1)/\sigma} \cdot \frac{\sigma}{1-\sigma} \bigg \}}
\end{align}
We can then construct aggregate trade flows by integrating across all different consumers. Aggregate imports of good $\omega$ from country $j$ in country $n$ are:
\begin{align}
M_{nj}(\omega) = \int\limits_{\mathcal{A} \times \mathcal{Z}} p_{nj}(\omega)\, c_{nj}(\omega)(a,z) \, \pi_{nj}(\omega)(a,z) \, da \, dz
\end{align}
where this is the value consumed by households of type $(a,z)$ times the probability that type $(a,z)$ households consume variety $j$, integrated across all types. Pause here for a second and notice this is delivering ``fruit salad'' like properties at the micro-level. Recall that in EK, for a given $\omega$, only one source is chosen. Here, because the taste shocks give every source a positive choice probability, for a given $\omega$ all sources will be supplying country $n$.

The final step is to impose the symmetry assumption, which means dropping the $\omega$ index. Again, this is much like the technological side of the Armington model. Aggregate trade flows become:
\begin{align}
M_{nj} = \int\limits_{\mathcal{A} \times \mathcal{Z}} p_{nj}\, c_{nj}(a,z) \, \pi_{nj}(a,z) \, da \, dz \label{eq:imports}
\end{align}
Imports take on a mixed logit formulation that very much mimics that used in the industrial organization literature | for example, \citet{berry1995automobile}. There are, however, several interesting differences. First, there is an active intensive margin, not unit demand. Second, a key issue shaping the choice probabilities is the marginal utility of wealth (which is an endogenous object, not a parameter). Third, the distribution over which demands are aggregated is endogenous. Household behavior (which variety to purchase) determines the distribution of wealth, which in turn determines the aggregate demand for a variety. In other words, this model imposes cross-equation restrictions between aggregate demand and individual demands through the distribution. So it is not a free parameter as in the IO literature, and it will change with changes in the primitives of the environment.

\section{The HA Trade Elasticity}

One of the questions that I'm interested in is: How does the introduction of household heterogeneity change how aggregate trade flows respond to changes in trade costs. In other words, how does household heterogeneity affect the trade elasticity. To answer this question, first define the trade elasticity as:
\begin{align}
\theta_{nj} = \frac{\partial M_{nj}/M_{nj}}{\partial d_{nj}/d_{nj}} - \frac{\partial M_{nn}/M_{nn}}{\partial d_{nj}/d_{nj}},
\label{eq:theta-def}
\end{align}
which measures the percentage change in imports from country $j$ relative to the percentage change in domestic purchases, in response to a one percent increase in bilateral trade costs $d_{ij}$. This is a partial equilibrium object, so I hold wages $w_j$ and all prices $p_{nj'}$ for $j' \neq j$ fixed.

Before computing these derivatives, notice that we can express imports as 
\begin{align}
M_{nj} = \int_{\mathcal{A} \times \mathcal{Z}} \lambda_{n}(a,z)^{-1/\sigma} \cdot p_{nj}^{\alpha}  \cdot \pi_{nj}(a,z) \, da \, dz, \label{eq:imports-lambda}
\end{align}
where $\alpha \equiv (\sigma-1)/\sigma$. For the first term in (\ref{eq:theta-def}), differentiate $M_{nj}$ with respect to $\ln p_{nj}$:
\begin{align}
\frac{\partial \ln M_{nj}}{\partial \ln d_{nj}} = \underbrace{\alpha}_{\text{intensive}}  + \int\limits_{\mathcal{A} \times \mathcal{Z}} \omega_{nj}(a,z) \, \underbrace{\frac{\partial \ln \pi_{nj}(a,z)}{\partial \ln p_{nj}}}_{\text{extensive}} da \, dz, \label{eq:Mij-decomp}
\end{align}
where I define the expenditure-share weight of type $(a,z)$ in total imports from $j$ as:
\begin{align}
\omega_{nj}(a,z) \equiv \frac{p_{nj} \, c_{nj}(a,z) \, \pi_{nj}(a,z)}{M_{nj}}.
\end{align}
Two terms appear in (\ref{eq:Mij-decomp}). The \textbf{intensive margin} gives the elasticity of conditional spending with respect to price:
\begin{align}
\partial \ln(p_{nj} c_{nj}) / \partial \ln p_{nj} = \frac{(\sigma-1)}{\sigma} \equiv \alpha.
\end{align}
This term has nothing to do with household heterogeneity. This relates to our two-stage budgeting discussing that we had in class. This says, conditional on spending on some good, how the household substitutes on the intensive margin just relates to the $\sigma$ term. 

The second terms is a expenditure weighted average of the \textbf{extensive margin.} And what I mean by the extensive margin is how consumers are moving across different goods and embodied by how the choice probability changes. How this object behaves is where we see wealth and income shaping trade elasticities. 


\textbf{Extensive Margin.} From the logit structure derived above, here are some convenient steps to differentiating it: The first step is to define the utility from purchasing variety (net of the taste shocks) as:
\begin{align}
V_{nj}(a,z) = \frac{\sigma}{1-\sigma} \big[ \lambda_{n}(a,z) \, p_{nj} \big]^{\alpha}.
\end{align}
Differentiating with respect to $\ln p_{nj}$:
\begin{align}
\frac{\partial V_{nj}(a,z)}{\partial \ln p_{nj}} = -\big[ \lambda_{n}(a,z) \, p_{nj} \big]^{\alpha}.
\end{align}
The next step is to use the standard logit derivative:
\begin{align}
\frac{\partial \ln \pi_{nj}(a,z)}{\partial \ln p_{nj}} &= \eta \cdot \frac{\partial V_{nj}(a,z)}{\partial \ln p_{nj}} \cdot \big[ 1 - \pi_{nj}(a,z) \big] \\
\nonumber \\
&= -\eta \big[ \lambda_{n}(a,z) \, p_{nj} \big]^{\alpha} \cdot \big[ 1 - \pi_{nj}(a,z) \big] . \label{eq:logit-own}
\end{align}
This is a key equation. Notice that there are several forces shaping the households elasticity on the extensive margin:
\begin{itemize}
\item First, is how $\lambda_{n}(a,z)$ shows up. What this mean is high marginal utility of wealth households (poor) will have larger price elasticities. Low marginal utility of wealth households (rich) will have small price elasticities. Importantly, this is working exactly in the direction that I wanted this to where the poor are price sensitive, rich are not. Just like the \citet{auer2022unequal} facts. 
    
\item Second, notice how the $p$ shows up there, which larger $p$s making the household more price sensitive. This is a formalization of what ``Marshalls Second Law of Demand'' that claimed that price elasticities are larger for higher priced goods. 
    
\item The final term is a share adjustment. In the paper with \citet{p-iq}, this has the interpretation of being about the market power that $j$ has in $n$. So more important markets for $a,z$ guys push elasticities down. I'm going to do a small market approximation below and ignore this term. 
\end{itemize}
Everything I've said so far about the extensive margin is for the individual. Now lets get to the aggregate elasticity. So first we have the term
\begin{align}
\frac{\partial \ln M_{nj}}{\partial \ln d_{nj}} = \alpha - \eta \cdot \int\limits_{\mathcal{A} \times \mathcal{Z}} \omega_{nj}(a,z) \, \bigg\{ \big[ \lambda_{n}(a,z) \, p_{nj} \big]^{\alpha} \cdot \big[ 1 - \pi_{nj}(a,z) \big] \bigg \} da \, dz. \label{eq:first-term}
\end{align}
The second term we need is how domestic purchases $M_{nn}$ change with $d_{mj}$. This term only changes through the extensive margin, we can apply the similar logit math:
\begin{align}
\frac{\partial \ln \pi_{nn}(a,z)}{\partial \ln d_{nj}} = \eta \big[ \lambda_{n}(a,z) \, p_{nj} \big]^{\alpha} \pi_{nj}(a,z),
\end{align}
where the sign is now positive: a rise in $d_{nj}$ diverts demand away from $j$ and toward the domestic variety $n$.

Given the weights $\omega_{nn}(a,z) \equiv p_{nn} c_{nn}(a,z) \pi_{nn}(a,z)/M_{nn}$:
\begin{align}
\frac{\partial \ln M_{nn}}{\partial \ln d_{nj}} = \eta \cdot \int\limits_{\mathcal{A} \times \mathcal{Z}} \omega_{nn}(a,z) \bigg\{ \big[\lambda_{n}(a,z) \, p_{nj} \big]^{\alpha} \cdot \pi_{nj}(a,z) \bigg \} da \, dz. \label{eq:second-term}
\end{align}
Then we can put (\ref{eq:first-term}) and (\ref{eq:second-term}) to arrive at a statement about the trade elasticity. 

The general trade elasticity is a complicated object. But to to provide more clarity about how things work, let's use the argument that most people purchase most stuff from home, so that $\pi_{nj}(a,z) \approx 0$ or small. Then the trade elasticity becomes
\begin{align}
\theta_{nj} = \alpha - \eta \cdot \int\limits_{\mathcal{A} \times \mathcal{Z}} \omega_{nj}(a,z) \, \, \big[ \lambda_{n}(a,z) \, p_{nj} \big]^{\alpha} \, da \, dz.
\end{align}
which is pretty nice. A couple of things about this: 
\begin{itemize}
\item The distribution of the marginal utility of wealth is a central object in shaping this elasticity. That is one can see how household heterogeneity matters for aggregate responses. 
    
\item Notice how trade elasticities now vary with $nj$ and this is working through (i) the price effect discussed below and (ii) expenditure patterns across households via $\omega(a,z)$.  
    
\item In aggregate, higher price destinations will have larger trade elasticities. This is very clear in the formulation as to how it is working. And again, it is like ``Marshalls Second Law of Demand'' in aggregate. There is some evidence on this. The key thing is that now geography is not only matters by shaping the level of trade, it will shape the response.
\end{itemize}

\subsection{Variation: Logarithmic Preferences}

This is an interesting and important case because it turns off household heterogeneity.  So set $u(c) = \log(c)$, so $\sigma = 1$.  The first-order condition in (\ref{eq:ce-intensive}) still applies, but now $u'(c) = 1/c$, so
\begin{align}
c_{nj}(a,z) = \frac{1}{\lambda_{n}(a,z) \, p_{nj}}.
\end{align}
Then expenditure on the chosen variety is:
\begin{align}
p_{nj} \, c_{nj}(a,z) = \frac{1}{\lambda_{n}(a,z)}.
\end{align}
Now this is important | expenditure is independent of the price, it only depends on the marginal utility of wealth. 

Now the next step is to construct the choice probabilities. With some algebra, one can show that the indirect utility from purchasing variety $j$, net of the taste shock, is:
\begin{align}
V_{nj}(a,z) = -\log(\lambda_{n}(a,z) \, p_{nj}) - 1.
\end{align}
Then we just plug this into the logit formulas:
\begin{align}
\pi_{nj}(a,z) = \frac{\exp\big\{ \eta \big[-\log(\lambda_{n}(a,z) \, p_{nj}) - 1\big]\big\}}{\sum\limits_{j' \in J}\exp\big\{ \eta \big[-\log(\lambda_{n}(a,z) \, p_{nj'}) - 1\big]\big\}}.
\end{align}
The $-1$ terms cancel between numerator and denominator. Critically, the $-\log(\lambda_{n}(a,z))$ terms cancel as well. We are left with:
\begin{align}
\pi_{nj}(a,z) = \frac{p_{nj}^{-\eta}}{\sum\limits_{j' \in J} p_{nj'}^{-\eta}} \equiv \pi_{nj}. \label{eq:log-choice-prob}
\end{align}
The marginal utility of wealth drops out entirely. Choice probabilities are identical across all household types! Rich and poor choose varieties with the same probabilities.

\textbf{Log Preferences Trade Elasticity.} Now trace the implications for the trade elasticity. First, $\alpha = (\sigma-1)/\sigma = 0$, so the intensive margin contribution is zero. With log preferences, the income and substitution effects on conditional expenditure exactly offset.

For the extensive margin, differentiate (\ref{eq:log-choice-prob}) with respect to $\ln p_{nj}$:
\begin{align}
\frac{\partial \ln \pi_{nj}}{\partial \ln p_{nj}} = -\eta \big(1 - \pi_{nj}\big),
\end{align}
which is now independent of $(a,z)$. Since the choice probability does not depend on household type, it factors out of the integral in the aggregate elasticity expression. Similarly, the domestic term gives:
\begin{align}
\frac{\partial \ln \pi_{nn}}{\partial \ln d_{nj}} = \eta \, \pi_{nj}.
\end{align}
Combining gives the trade elasticity:
\begin{align}
\theta_{nj} = -\eta(1-\pi_{nj}) - \eta \, \pi_{nj} = -\eta.
\end{align}
\textbf{WOW!} This is crazy. We have all this heterogeneity in the back ground, but it plays zero role in shaping how trade responds to shocks. The trade elasticity is simply $-\eta$, a constant.  The model collapses to something that looks like standard \citet{eaton2002technology} gravity with $\eta$ playing the role of the Fr\'{e}chet shape parameter.

\subsection{Variation: CES preferences (Fruit Salad)}

One the things I've been making a big deal of is the perfect substitute view of the world. That is within each market, different national varieties perfect substitutes for each other. Let's just confirm what happens in the Fruit Salad model. Rather than perfect substitutes, assume that preferences are set up as:
\begin{align}
\mathbb{E}_{0} \sum_{t = 0}^{\infty} \beta \, \int_0^1 \bigg\{ \sum_{j} c_{njt}(\omega)^{\frac{\sigma - 1}{\sigma}} \bigg \}  d\omega.
\end{align}
There are no indicator functions $x_{nj}(\omega)$ and no taste shocks $\epsilon_{njt}(\omega)$. Households consume positive amounts of all varieties of each good | this is the ``fruit salad'' model.

The first-order condition for variety $j$ of good $\omega$ is:
\begin{align}
\frac{\sigma - 1}{\sigma} \, c_{nj}(\omega)^{-1/\sigma} = \lambda_{n}(a,z) \, p_{nj}(\omega),
\end{align}
which gives
\begin{align}
c_{nj}(\omega) = \alpha^{\sigma} \, \lambda_{n}(a,z)^{-\sigma} \, p_{nj}(\omega)^{-\sigma},
\end{align}
where $\alpha \equiv (\sigma-1)/\sigma$ as before. Then expenditure on variety $j$ of good $\omega$ is:
\begin{align}
p_{nj}(\omega) \, c_{nj}(\omega) = \alpha^{\sigma} \, \lambda_{n}(a,z)^{-\sigma} \, p_{nj}(\omega)^{1-\sigma}.
\end{align}
Here is an \textbf{important }observation: $\lambda_{n}(a,z)^{-\sigma}$ enters as a multiplicative scalar that is the \emph{same} across all varieties $j$. Thus it will cancel out when things are expressed as expenditure shares. What is going on here is that rich households spend more on every variety, but allocate \textbf{across} varieties in the same proportions as poorer households.

Imposing the symmetry assumption and integrating across household types, aggregate imports are
\begin{align}
M_{nj} = \alpha^{\sigma} \, p_{nj}^{1-\sigma} \int\limits_{\mathcal{A} \times \mathcal{Z}} \lambda_{n}(a,z)^{-\sigma} \, da \, dz.
\end{align}
and here one can see how nothing in the integral depends upon $p_{nj}$. This is already previewing the result that household heterogeneity may affect the \textbf{level} of trade, but not the change. This is in contrast to (\ref{eq:imports-lambda}) where the price is inside the integral. Specifically, in the choice probabilities the price is intertwined with the marginal utilities, and thus they interact. 

\textbf{Fruit Salad Trade Elasticity.} Since the integral does not depend on $p_{nj}$:
\begin{align}
\frac{\partial \ln M_{nj}}{\partial \ln d_{nj}} = 1 - \sigma.
\end{align}
There is no extensive margin, every household purchases positive amounts of every variety, so there is no margin of variety switching. Then there are domestic purchases $M_{nn}$, which do not respond to a change in $d_{nj}$. To see this note that:
\begin{align}
M_{nn} = \alpha^{\sigma} \, p_{nn}^{1-\sigma} \int\limits_{\mathcal{A} \times \mathcal{Z}} \lambda_{n}(a,z)^{-\sigma} \, da \, dz.
\end{align}
So a change in the trade costs does not directly change $p_{nn}$. And it does not directly change the marginal utility of wealth, thus $M_{nn}$ does not move. Thus, the trade elasticity is:
\begin{align}
\theta_{nj} = 1 - \sigma.
\end{align}
Notice that household heterogeneity is irrelevant here, because $\lambda_{n}(a,z)$ only affects the level of expenditures, nothing about the change. Mechanically the issue is that the price can be pulled outside of the integral. In HAT, it can't because of how the integral interacts with the extensive margin of consumers. The $\log$ model is a knife edge case which is working differently because there the extensive margin is the same for rich and poor households, thus the issues about integration don't matter at all.  

\subsection{Variation: Fruit Salad with Heterogeneous Elasticities}

This is, I think, a really dumb model. Oddly, many people ask me about it. This model is a variation on the fruit salad model where agents with different assets and income have different elasticities of substitution baked in. So a set-up like this:
\begin{align}
\mathbb{E}_{0} \sum_{t = 0}^{\infty} \beta \, \int_0^1 \bigg\{ \sum_{j} c_{njt}(\omega)^{\frac{\sigma(a,z) - 1}{\sigma(a,z)}} \bigg \}  d\omega.
\end{align}
The first-order condition for variety $j$ of good $\omega$ for a household of type $(a,z)$ is:
\begin{align}
\frac{\sigma(a,z) - 1}{\sigma(a,z)} \, c_{nj}(\omega)^{-1/\sigma(a,z)} = \lambda_{n}(a,z) \, p_{nj}(\omega),
\end{align}
which gives
\begin{align}
c_{nj}(\omega) = \alpha(a,z)^{\sigma(a,z)} \, \lambda_{n}(a,z)^{-\sigma(a,z)} \, p_{nj}(\omega)^{-\sigma(a,z)},
\end{align}
where $\alpha(a,z) \equiv (\sigma(a,z)-1)/\sigma(a,z)$. Then expenditure on variety $j$ of good $\omega$ is:
\begin{align}
p_{nj}(\omega) \, c_{nj}(\omega) = \alpha(a,z)^{\sigma(a,z)} \, \lambda_{n}(a,z)^{-\sigma(a,z)} \, p_{nj}(\omega)^{1-\sigma(a,z)}.
\end{align}
The exponent on $p_{nj}$ now varies with $(a,z)$. So when we impose symmetry and integrate to get aggregate imports:
\begin{align}
M_{nj} = \int\limits_{\mathcal{A} \times \mathcal{Z}} \alpha(a,z)^{\sigma(a,z)} \, \lambda_{n}(a,z)^{-\sigma(a,z)} \, p_{nj}^{1-\sigma(a,z)} \, da \, dz,
\end{align}

\textbf{Fruit Salad with Heterogeneous Elasticities Trade Elasticity.} This is a mouthful. Differentiating with respect to $p_{nj}$:
\begin{align}
\frac{\partial \ln M_{nj}}{\partial \ln d_{nj}} = \int\limits_{\mathcal{A} \times \mathcal{Z}} \omega_{nj}(a,z) \, \big[1 - \sigma(a,z)\big] \, da \, dz,
\end{align}
where the expenditure-share weights are:
\begin{align}
\omega_{nj}(a,z) = \frac{p_{nj} \, c_{nj}(a,z)}{M_{nj}}.
\end{align}
Domestic purchases $M_{nn}$ do not respond --- $p_{nj}$ appears nowhere in $M_{nn}$, the same argument as before. Thus the trade elasticity is:
\begin{align}
\theta_{nj} = \int\limits_{\mathcal{A} \times \mathcal{Z}} \omega_{nj}(a,z) \, \big[1 - \sigma(a,z)\big] \, da \, dz.
\end{align}
Heterogeneity now matters | even in fruit salad. The trade elasticity is a weighted average of type-specific elasticities $1 - \sigma(a,z)$, and the weights themselves depend on $nj$ because the weights will be different across trading partners. 

Now notice two key differences:
\begin{itemize}
\item First, we still need to make additional parametric assumptions about how $\sigma(a,z)$ co-varies with $a$ and $z$. In HAT, the individual elasticities are tied to $a$ and $z$ through the marginal utility of wealth. And how the marginal utility of wealth varies across households dictates the trade elasticity. Not a parametric restriction.

\item A second key difference is that in HAT, the individual extensive margin elasticity has the price is \emph{inside} the individual elasticity, so households become more price sensitive when facing a higher-priced variety. That is Marshall's Second Law operating at the household level which then shows up at the aggregate level. In the heterogeneous fruit salad world, the price $p_{nj}$ only shows up in the weights $\omega_{nj}(a,z)$. Thus, the price affects \emph{which} households matter more in the weighted average, but not directly through individual elasticities. In other words, \textbf{if} this did deliver Marshall's Second Law at the aggregate (which would depend on additional assumptions about $\sigma(a,z)$), it would be purely through composition. 

Another way frame this last point is in terms of the super-elasticity. In HAT, how the elasticity would change with respect to price would have two channels | how individual elasticities change \textbf{and} how weights change. In the Heterogenous-Fruit Salad model, it would be only through how weights change. 
\end{itemize}

\newpage

\section{The Asset Market and Balance of Payments}

%\begin{align}
%M_{nj} = \int\limits_{\mathcal{A} \times \mathcal{Z}} p_{nj}\, c_{nj}(a,z) \, \pi_{nj}(a,z) \, da \, dz \label{eq:imports}
%\end{align}

I know there is some interest in this, so let me talk briefly about how the asset market operates. As a first step we are going to construct some aggregates so similar to imports, aggregate bilateral exports from country $i$ to country $j$ are
\begin{align}
X_{jn} = \int\limits_{\mathcal{A} \times \mathcal{Z}}   p_{jn} c_{jn}(a, z) \pi_{jn}(a, z) da \ dz.
\label{eq:exports}
\end{align}
The value of aggregate expenditure is
\begin{align}
\widetilde{E_n}  &=  \sum_{j} \int\limits_{\mathcal{A} \times \mathcal{Z}} p_{nj}\, c_{nj}(a,z) \, \pi_{nj}(a,z) \, da \, dz \label{eq:bigC}
\end{align}
Finally, the aggregate quantity of asset holdings integrates across the asset choices of individual households
\begin{align}
\mathrm{A}_n' = \int\limits_{\mathcal{A} \times \mathcal{Z}}  g_{n}(a, z) da \ dz.
\label{eq:aggregate_asset}
\end{align}
which integrates over the asset choices|given the policy function $g_{i}(a, z)$.

\textbf{National Accounting.} From here, I reconstruct national income and product identities. If we start from the production side, aggregate efficiency units are
\begin{align}
N_n = \int_{\mathcal{Z}}\ z \ dz. \label{eq:ag-labor-supply}
\end{align}
The value of aggregate production must equal aggregate payments to labor so
\begin{align}
p_{n} Y_{n} = p_{n} A_{n} N_{n} = \int_{\mathcal{Z}}\ w_n \cdot z \ dz,
\label{eq:value_production}
\end{align}
Then, if we sum over individual consumers' budget constraint and substitute in (\ref{eq:value_production}), the aggregated budget constraint is:
\begin{align}
p_{n} Y_{n}  = \widetilde{E_n}  + \bigg[-R_i\mathrm{A_n} +  \mathrm{A_n'} \bigg],
\label{eq:aggregate_budget_constraint}
\end{align}
where national income equals the value of aggregate consumption $\widetilde{P_{n} C_n}$ and the country's net factor payments and net asset position. To arrive at the standard national income accounting identity, simply work with the relationship between production, exports, and aggregate consumption in (\ref{eq:bigC}) and imports. Doing so gives rise to
\begin{align}
p_{n} Y_{n}  = \widetilde{E_n} + \bigg[\ \sum_{j\neq i}X_{jn} -  \sum_{j\neq i}M_{nj} \bigg],
\label{eq:gdp}
\end{align}
where national production or GDP equals expenditure plus exports minus imports. A comparison of (\ref{eq:aggregate_budget_constraint}) and (\ref{eq:gdp}) then makes clear that the trade imbalance is connected with a country's net factor payments and net asset position.

\subsection{An Equilibrium}

In this section, I discuss the market clearing conditions that an equilibrium must respect and then define the decentralized stationary equilibrium of this economy.

\textbf{The Goods Market.} Goods market clearing equates the value of production of commodity $i$  with global demand for country $i$'s commodity:
\begin{align}
p_{i} Y_{i} &= \sum_{j}  X_{ji} \label{eq:goods-supply},
\end{align}
where the left hand side is production and the right hand side is world demand for the commodity (via exports) from (\ref{eq:exports}).

\textbf{The Bond Market.} The second market clearing condition is the bond market. There are two cases worth thinking about here. One is of ``financial autarky'' in which there is a local bond market that facilitates asset trades within a country but not across countries. In this case, there is an interest rate $R_i$ for each country, and the associated market clearing condition is
\begin{align}
\mathrm{A_i'} = 0, \ \ \forall i
\label{eq:bond-market-country}
\end{align}
which says that net asset demand within each country $i$ must be zero. As is common in the trade literature, this condition implies that trade is balanced|just stare at (\ref{eq:aggregate_budget_constraint}) and (\ref{eq:gdp}). Yet, even with balanced trade, there is still within-country trade of financial assets. Some households are savers, others are borrowers, and the interest rate is that at which the net asset position is zero. The second case is ``financial globalization'' where there is a global bond market that facilitates both within country asset trade, and across countries. In this case, there is a single interest rate $R$, and the associated market clearing condition is
\begin{align}
\sum_{i}\mathrm{A_i'} = 0.
\label{eq:bond-market-globalization}
\end{align}
In this case trade need not be balanced for each country. Here, a specific country might run a trade deficit, because at the given prices, the total amount of borrowing within a country is larger than the total amount of saving. However, across all countries total borrowing must equal total saving.

\section{Gains from Trade}

I'm going to simplify this. Consider the static HAT environment where a household in country $n$ with wealth $W$ has indirect utility $v_n(W; d_{nj})$. We want to characterize the welfare effect of a change in bilateral trade costs $d_{nj}$, holding wealth fixed. I'm also going to do this to a second-order so we can see certain things going on. 

So first, let's just start with the indirect utility function and take a second-order Taylor expansion in $\ln d_{nj}$:
\begin{align}
\Delta v_n(W) \approx \frac{\partial v_n}{\partial \ln d_{nj}} \, \Delta \ln d_{nj} + \frac{1}{2} \frac{\partial^2 v_n}{\partial (\ln d_{nj})^2} \, (\Delta \ln d_{nj})^2.
\end{align}
where the expansion point is always at the initial trade costs and all other equilibrium objects. 

Now this simple HAT environment where a household in country $n$ with wealth $W$ solves:
\begin{align}
v_n(W; d_{nj}) = \max\limits_{x_{nj}(\omega), \, c_{nj}(\omega)} &\int_0^1 \bigg\{ \sum_{j \in J} x_{nj}(\omega) \bigg[ u(c_{nj}(\omega)) + \epsilon_{nj}(\omega) \bigg] \bigg\} d\omega \nonumber \\
\nonumber \\
+ \, &\lambda_n(W) \bigg[ W - \int_0^1 \sum_{j \in J} x_{nj}(\omega) \, p_{nj}(\omega) \, c_{nj}(\omega) \, d\omega \bigg], \label{eq:static-hat}
\end{align}
where now we have the marginal utility of wealth $\lambda_n(W)$ rather than the $a,z$ notation above.

\textbf{First derivative.} By the envelope theorem, we holding all choice variables fixed, and then focus just on direct effects through prices (this follows the previous notes). The only place $d_{nj}$ enters (through $p_{nj} = d_{nj} \cdot w_j / z_j$) is in the expenditure term:
\begin{align}
\frac{\partial v_n}{\partial \ln d_{nj}} = -\lambda_n(W) \int_0^1 x_{nj}(\omega) \, p_{nj}(\omega) \, c_{nj}(\omega) \, d\omega.
\end{align}
With symmetry across $\omega$ and the law of large numbers replacing the realized indicator $x_{nj}(\omega)$ with its probability:
\begin{align}
\frac{\partial v_n}{\partial \ln d_{nj}} = -\lambda_n(W) \cdot m_{nj}(W),
\end{align}
where $m_{nj}(W) = \pi_{nj}(W) \, p_{nj} \, c_{nj}(W)$ is import expenditure on goods from $j$ for a household with wealth $W$. Now notice, this is exactly like in the other frameworks where the direct effect through prices is just about the expenditure share. In this case, its about an individual for a given wealth level. 

\textbf{Second derivative.} Differentiate again with respect to $\ln d_{nj}$, holding $\lambda_n(W)$ fixed:
\begin{align}
\frac{\partial^2 v_n}{\partial (\ln d_{nj})^2} = -\lambda_n(W) \cdot \frac{\partial m_{nj}(W)}{\partial \ln d_{nj}}.
\end{align}
Writing in elasticity form:
\begin{align}
\frac{\partial m_{nj}(W)}{\partial \ln d_{nj}} = m_{nj}(W) \cdot \frac{\partial \ln m_{nj}(W)}{\partial \ln d_{nj}} = m_{nj}(W) \cdot \theta_{nj}(W),
\end{align}
where $\theta_{nj}(W)$ is the individual-level trade elasticity. So:
\begin{align}
\frac{\partial^2 v_n}{\partial (\ln d_{nj})^2} = -\lambda_n(W) \cdot m_{nj}(W) \cdot \theta_{nj}(W).
\end{align}

\textbf{Putting it together.} Dividing through by the marginal utility of wealth $\lambda_n(W)$ to express everything in money-metric terms:
\begin{align}
\frac{\Delta v_n(W)}{\lambda_n(W)} \approx -m_{nj}(W) \, \Delta \ln d_{nj} - \frac{1}{2} \, m_{nj}(W) \cdot \theta_{nj}(W) \, (\Delta \ln d_{nj})^2. \label{eq:welfare-approx}
\end{align}
The first-order effect is import exposure | how much the household spends on goods from $j$. The second-order effect is import exposure times the \textbf{individual-level trade elasticity}. It's at this point one could see how elasticities could matter. Let's explore some different models. 

\subsection{HAT}

Impose the CRRA functional form $u(c) = c^{1-\sigma}/(1-\sigma)$ and the Type 1 Extreme Value distribution on taste shocks. The objects in (\ref{eq:welfare-approx}) are:
\begin{align}
m_{nj}(W) &= \pi_{nj}(W) \cdot \lambda_n(W)^{-1/\sigma} \cdot p_{nj}^{\alpha},
\end{align}
and recall that the individual trade elasticity is:
\begin{align}
\theta_{nj}(W) = \alpha - \eta \big[\lambda_n(W) \, p_{nj}\big]^{\alpha} \big(1 - \pi_{nj}(W)\big).
\end{align}
Both $m_{nj}(W)$ and $\theta_{nj}(W)$ depend on $\lambda_n(W) p_{nj}$. This is interesting because it implies several things. First,  conditional on exposure (the $m$s) poor households will have larger gains than rich households. Second, notice how this affect is compounded when thinking about the geography of this. For expensive destinations, conditional on exposure, elasticities are larger through $p$ and thus reductions in trade costs in those destinations are more beneficial than near by destinations. 

Now let's contrast this will several alternatives.

\subsection{Simple Fruit Salad}

In the fruit salad model with common $\sigma$, the welfare approximation in (\ref{eq:welfare-approx}) still applies, but the objects simplify considerably. There are no choice probabilities --- every household buys every variety --- so import expenditure is:
\begin{align}
m_{nj}(W) = \alpha^{\sigma} \, \lambda_n(W)^{-\sigma} \, p_{nj}^{1-\sigma},
\end{align}
and the individual trade elasticity is:
\begin{align}
\theta_{nj}(W) = 1 - \sigma.
\end{align}
The trade elasticity is a constant --- the same for all households. The welfare approximation becomes:
\begin{align}
\frac{\Delta v_n(W)}{\lambda_n(W)} \approx -m_{nj}(W) \, \Delta \ln d_{nj} - \frac{1}{2} \, m_{nj}(W) \cdot (1-\sigma) \, (\Delta \ln d_{nj})^2.
\end{align}
There are still heterogeneous welfare effects through the first-order term --- richer households (low $\lambda_n$) spend more on imports and thus benefit more in levels from a trade cost reduction. But the second-order adjustment is just a scalar multiple of the first-order effect. There is no additional force from differential responsiveness. 

\subsection{Heterogeneous Fruit Salad}

In the heterogeneous fruit salad model with $\sigma(W)$, the objects in (\ref{eq:welfare-approx}) are:
\begin{align}
m_{nj}(W) = \alpha(W)^{\sigma(W)} \, \lambda_n(W)^{-\sigma(W)} \, p_{nj}^{1-\sigma(W)},
\end{align}
where $\alpha(W) \equiv (\sigma(W)-1)/\sigma(W)$, and the individual trade elasticity is:
\begin{align}
\theta_{nj}(W) = 1 - \sigma(W).
\end{align}
The welfare approximation becomes:
\begin{align}
\frac{\Delta v_n(W)}{\lambda_n(W)} \approx -m_{nj}(W) \, \Delta \ln d_{nj} - \frac{1}{2} \, m_{nj}(W) \cdot \big[1 - \sigma(W)\big] \, (\Delta \ln d_{nj})^2.
\end{align}
This is an intermediate case. Unlike simple fruit salad, the second-order term now varies across households. Those with higher $\sigma(W)$ have larger elasticities and thus larger welfare adjustments at second order. unlike HAT, the individual elasticity $1 - \sigma(W)$ does not depend on $p_{nj}$ and thus the when thinking about situations across destinations, there is no extra ``kick'' when buying from a cheap source versus an expensive source.  


\newpage


\section{Solving the Model}

\subsection{EGM-Shopping-Cart Algorithm}

My computational approach exploits the Euler equation derived above. Below, I describe my algorithm, I will present everything as if we are in a stationary environment.
\begin{itemize}
\item[\textbf{0.}] Set up an asset grid. Then guess (i) an \textbf{expenditure} function $e(a,z)$ for each $a$, $z$. Note that this is not the consumption function, but how much the household plans to spend in units of the numeraire.

\item[\textbf{1.}] Find the $\lambda_{n}(a',z')$ that is associated with the given expenditure function $e(a',z')$. This entails solving the equation (\ref{eq:lambda-expenditure}), this is not a direct calculation but will entail some kind of numerical algorithim to solve for  $\lambda_{n}$ from equation (\ref{eq:lambda-expenditure}). Doing this fast and robustly is important. One approach would be to setup like a ``look-up table'' and interpolate off this. There is nothing about the states or dynamics that affects the relationship between $e$ and $\lambda_{n}$. Or store the old values of $\lambda_{n}$ with $e$ and interpolate off it as well.

\item[\textbf{2.}] Use the Euler Equation to find the implied $\lambda_{n}(\tilde a,z)$. Then from equation (\ref{eq:lambda-expenditure}), we \textbf{directly} have $e(\tilde a,z)$. The $\tilde a$ meas that these are values associated with some asset level, not necessarily ones on the grid.

\item[\textbf{3.}] A key issue in this method is that we have found  $e(\tilde a, z, j),$ where the expenditure function is associated with some asset level that is not necessarily on the grid. The solution is to use the budget constraint and infer $\tilde a$ given that $a'$, was chosen above (that's where we started), $z$, and $e(\tilde a, z)$. Now, I have a map from $\tilde a$ to $a'$ for which one can use interpolation to infer the $a'$ chosen given $a$ where $a$ is on the grid.

\item[\textbf{4.}] From step \textbf{3.}, we have an asset policy function mapping $a -> a'$. Given this asset policy function, we can use the budget constraint and we have an updated expenditure function $e'(a,z)$.

\item[\textbf{4.1}] How is the constraint being handled? The interpolation scheme is setup to force things to be on the grid, so if the implied $a$ is below the constraint, it just forces the household to be at $\phi$ and then expenditure comes off the budget constraint.

\item[\textbf{5.}] Compare old and new expenditure functions, and then update accordingly.
\end{itemize}


\newpage
\clearpage

\bibliography{./bibtex/micro_price_bibtex}



\end{onehalfspacing}

\end{document}










